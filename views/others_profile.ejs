<!DOCTYPE html>
<html>
    <head>
        <title>Profile Page</title>
		<script src="https://cdn.jsdelivr.net/npm/he/he.js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Allura&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/others_profile.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Shrikhand&family=Tilt+Prism&display=swap" rel="stylesheet">
	 <link rel="canonical" href="https://getbootstrap.com/docs/5.3/examples/navbars/">
	 <link href="../assets/dist/css/bootstrap.min.css" rel="stylesheet">
	 <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

	 <style>
		.navbar {
			z-index: 1 !important;
			background-color: orange !important;
			height: 90px;
		  }
		 </style>

    </head>
<header>
	<nav class="navbar navbar-expand-lg navbar-light bg-warning">
		<div class="container-fluid">
		  <a class="hobbyist navbar-brand" href="#">Hobbyist</a>
		  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		  </button>
		  <div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul class="navbar-nav ms-auto mb-2 mb-lg-0">
			  <li class="nav-item">
				<a class="nav-link d-flex flex-column align-items-center" href="/home_page">
				  <img src="https://cdn-icons-png.flaticon.com/512/25/25694.png" style="width: 40px; height: 40px;" alt="Profile Picture" class="rounded-circle me-2">
				  <span>Home</span>
				</a>
			  </li>
		  <li class="nav-item">
			<a class="nav-link d-flex flex-column align-items-center" href="/feed">
			  <img src="https://cdn-icons-png.flaticon.com/512/6565/6565268.png" style="width: 40px; height: 40px;" alt="Profile Picture" class="rounded-circle me-2">
			  <span>Feed</span>
			</a>
			</li>
			  <li class="nav-item dropdown">
				<a class="nav-link d-flex flex-column align-items-center" href="#" id="navbarDropdownFriends" role="button" data-bs-toggle="dropdown" aria-expanded="false">
				  <img src="    https://cdn-icons-png.flaticon.com/512/10313/10313078.png" style="width: 40px; height: 40px;" alt="Profile Picture" class="rounded-circle me-2">
				  <span>Friends</span>
				</a>
				<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownFriends">
				  <li><a class="dropdown-item" href="#">Connect with Friends</a></li> <!--FIX THIS-->
				  <li><a class="dropdown-item" href="/myFriends_Page">My Friends</a></li>
				</ul>
			  </li>
			  <li class="nav-item">
				<a class="nav-link d-flex flex-column align-items-center" href="/rooms">
				  <img src="https://cdn-icons-png.flaticon.com/512/9234/9234940.png" style="width: 40px; height: 40px;" alt="Profile Picture" class="rounded-circle me-2">
				  <span>Rooms</span>
				</a>
			  </li>
			  <li class="nav-item dropdown">
				<a class="nav-link d-flex flex-column align-items-center" href="#" id="navbarDropdownPicture" role="button" data-bs-toggle="dropdown" aria-expanded="false">
				  <img src=<%=myProfile.profilePicture%> style="width: 40px; height: 40px;" alt="Profile Picture" class="rounded-circle me-2">
				  <span><%=myProfile.user.username%></span>
				</a>
				<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownPicture">
				  <li><a class="dropdown-item" href="/profile/<%=myProfile.user.username%>">My Profile</a></li>
			<li><a class="dropdown-item"  href="#">My Posts</a></li>
				  <li><a class="dropdown-item" id="logout-button" href="#">Logout</a></li>
				</ul>
			  </li>
			</ul>
		  </div>
		</div>
			<script>
			const logoutButton = document.getElementById('logout-button');
			logoutButton.addEventListener('click', async (event) => {
				event.preventDefault();
				try {
					window.location.href = "/logout";
				} catch (err) {
					alert("Logout unsuccessful");
				}
			});
			</script>
    </nav>

	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
 	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

</header>
    <body>
	<div class="profile-container">
		<div class="profile-image-container">
			<img class="profile-image" src=<%=otherProfile.profilePicture%> alt="Profile Picture">
			<h1 class="profile-name"><%=otherProfile.user.firstName + " " + otherProfile.user.lastName%></h1>
			<h3 class="profile-username"> <%="@"+otherProfile.user.username%></h3>
            <button class="edit-profile-button" id="edit-profile-button">Edit profile</button>
			
			<button class="friend-request-button" id="friend-request-button">Send Friend Request</button>
			<div id="error-message" style="display: none;"></div>
			<script> 
			if ('<%= currentUserId %>' === '<%=requestedUserId%>'){
			document.getElementById('friend-request-button').style.display = "none";
			const editProfileButton = document.getElementById('edit-profile-button');
				editProfileButton.addEventListener('click', (event) => {
					event.preventDefault();
					window.location.href = 'edit/';
				});
			}
			else {
			document.getElementById('edit-profile-button').style.display = "none";
			// check if already a friend FIX
			const friends = '<%=JSON.stringify(otherProfile.user.friends)%>';
			const friendReqButton = document.getElementById('friend-request-button');
			if (friends.includes('<%=myProfile.user.username%>')) {
				friendReqButton.textContent = "Following";
				friendReqButton.disabled = true;
			}
			// check if pending , else give option to add friend
			else {
				
				fetch('/api/friendships/check-request', {
					method: 'POST',
					headers: {"Content-Type":"application/json; charset=UTF-8"},
					body: JSON.stringify({
							myUserId: '<%=myProfile.user._id%>',
							otherUserId: '<%=otherProfile.user._id%>'
							})
						})
						.then(response => response.json())
						.then(data => {
						if (data.status === "Request pending!") {
							friendReqButton.textContent = "Request pending...";
							friendReqButton.disabled = true;
						} else if (data.status === "Not friends!") {
							friendReqButton.textContent = "Add friend";	
								
								friendReqButton.addEventListener("click", (event) =>{
									event.preventDefault();
									fetch('/api/friendships/request/', {
										method: 'POST',
										headers: {"Content-Type":"application/json; charset=UTF-8"},
										body: JSON.stringify({
											sender: '<%=myProfile.user._id%>',
											receiver: '<%=otherProfile.user._id%>'
										})
									})
									.then(response => response.json())
									.then(data => {
										if (data.status === 'Request successfully sent!'){
											friendReqButton.textContent = "Request pending...";
											friendReqButton.disabled = true;
										}
									}).catch(error => {
										const errorMessage = document.getElementById('error-message');
										errorMessage.textContent = 'Failed to send friend request!' + error.message;
										errorMessage.style.display = 'block';
									})
								})
							
							}
						}).catch(error => console.error(error));
						}		
				}
			
			</script>
		</div>
		<div class="profile-info-container">
			<div class="profile-details-container">
				<div class="profile-detail">
					<h3>Hobbies</h3>
					<p id="hobbies-list"> <script> 
						const hobbiesArray = '<%=otherProfile.hobbies%>';
						const hobbiesList = document.getElementById('hobbies-list');
						if (hobbiesArray.length === 0) hobbiesList.innerText = "N/A"
						else hobbiesList.innerText = hobbiesArray;
					</script>
					</p>
				</div>
				<div class="profile-detail">
					<h3>Description</h3>
					<p id="description"> <script> 

					var myString = he.decode('<%=otherProfile.description%>');
					document.getElementById("description").innerHTML = myString.replace(/\n/g, "<br>");
					</script>
					</p>
				</div>
				<div class="profile-detail">
					<h3>Location</h3>
					<p id="location"><script>
						document.getElementById('location').innerHTML = '<%=otherProfile.location%>';
					</script>
					</p>
				</div>
				<div class="profile-detail">
					<h3>Gender</h3>
					<p id="gender"> <script>
						document.getElementById('gender').innerHTML = '<%=otherProfile.gender%>';
					</script></p>
				</div>
			</div>
		</div>
	</div>
</body>

</html>
